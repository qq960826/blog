---
title: I2C协议
url: 184.html
id: 184
comments: false
categories:
  - 单片机
date: 2015-12-26 13:21:00
tags:
---

首先我通过我查阅了相关I2C协议的资料,发现这篇文章不错，所以进行翻译。以下内容是博主自己翻译的，不要吐槽博主翻译水平，英语水平一般。。。 
原文地址[http://www.robot-electronics.co.uk/i2c-tutorial](http://www.robot-electronics.co.uk/i2c-tutorial) 
**物理I2C总线**
除了VCC和GND以外，还有两根线，分别为SCL和SDA。SCL是时钟线，它是用来同步在I2C总线上所有的数据交换。SDA是数据线。SDA和SCL连接了在I2C总线上的所有设备。SCL和SDA线都是“开漏输出”设备。这意味着芯片可以使它的输出为低电平，但不能变为高电平。为了能输出高电平，你必须提供一个连接5v电源的上拉电阻。应该有一个电阻连接SCL和5v电源和另一个电阻连接SDA和5V电源。你只需要2个上拉电阻对于整个I2C总线，不用对每个设备都要，由下图所示。
[![i2ca](/images/old/2015/12/i2ca.gif)](/images/old/2015/12/i2ca.gif)
电阻的阻值没有严格要求，我见过使用从1800欧姆到47000欧姆到。1k7，4k7和10k是常用的阻值，但是任何在这区间的阻值都是可以的。为推荐4k8因为它给你最好的效果。如果没有这一个电阻，SCL和SDA线会总是低电平（接近0v），而且I2C总线将不会工作
**主机和从机**
在I2C总线上的设备要么是主机要么是从机。总是控制SCL线的设备是主机。从机是响应主机的设备。从机不能发起数据的交换在I2C总线上，只有主机能这样做。通常可以有多个从机在I2C总线上，然而正常情况下只有一台主机。也有可能有多个主机，但是它不常见，这里就不讨论了。在你的机器人中，单片机将会是主机，而MPU6050是从机。从机永远都不会发起数据交换。主机和从机能在I2C总线上交换数据，但是这种数据交换总是受到主机的控制。 
**I2C物理协议**
当主机（你的单片机）想要对从机通信时，它通过发起一个开始信号（start sequence ）在I2C总线上。开始信号和终止信号是定义在I2C总线上的两个特殊信号。开始信号和终止信号的特殊之处是在它俩唯一能在SCL是高电平能发生改变。当有数据传输的时候，当SCL为高电平的时候，SDA必须保持稳定不能发生变换。开始信号和终止信号标记与从机进行交换数据的开始与结束。 开始信号:当SCL为高电平时，SDA由高电平变为低电平 终止信号：当SCL为低电平时，SDA由低电平变为高电平 如图 
[![i2cb](/images/old/2015/12/i2cb.gif)](/images/old/2015/12/i2cb.gif) 
数据是以连续的8位进行传输，SDA从最高有效位（MSB）开始传输，SCL线先上沿变高，然后变低。记住芯片不能真正的使总线上的电压变高，通常使用上拉电阻使其变高。对于每8位传输完成后，接受数据的设备将会返回一个低电平的确认位（ACK）来确认它已经收到了数据并且准备接受接下来的数据。如果确认位返回的是高电平，则暗示着它不能接受后面的数据，要让另外一台设备等待，直到变为低电平。
[![QQ20151226-0@2x](/images/old/2015/12/QQ20151226-0@2x.png)](/images/old/2015/12/QQ20151226-0@2x.png) 
**有多快？** 
标准的I2C时钟速度可以达到100KHz。飞利浦定义了更快的传输速度：达到400KHz的快速模式，和达到3.4MHz的高速模式。我们所有的组建设计可以达到100KHz。我已经测试过我的组建达到1MHz，但是在每字节传输的时候需要几微秒的延时。在实际的机器人中，我没有任何需求去使用高速模式。别管那么多，使SCL的变化频率小于100KHz就行 
**I2C设备地址** 
所有的I2C设备地址要么是7位要么就是10位。10位地址的使用很罕见，这里就不讨论了。我们的所有的组件和通常的你将使用的新品有7位地址。这意味着你可以用到高达127个设备在I2C总线上，因为7位可以组成0到127.当发完7位地址后，我们还要发送第八位。多余的一位是告诉从机主机是向它读取数据还是写入数据。如果第8位是0那么主机是向从机写入数据。如果第八位是1那么主机是从从机读取数据。7位的地址在高位，读写位在最低位(LSB)
[![i2cd](/images/old/2015/12/i2cd.gif)](/images/old/2015/12/i2cd.gif) 
7位地址放在高7位是新手疑惑的源头。这一位为了写入地址21（十进制），你必须发送21的2倍42（从二进制的角度来讲左移1位）。或许也可以简单的认为I2C总线地址为8位，只读的奇数地址和只写的偶数地址。以CMPS03为例子，它的地址是0xC0.你使用0xC0去写入，使用0xC1去读取。所以读写位仅仅使它变成了一个奇数／偶数地址
**I2C软件协议** 第一件将会发生的事是主机发送一个开始信号，提醒总线上的从机一个会话开始了，他们应该开始监听接下来的信号，以防这个是对它们对会话。然后主机发送从机地址。地址符合的从机将会继续会话，其他的从机将会忽略剩下的会话然后等待下一次会话的开始。有了地址符合的从机后，主机将会发送想要读写的内部地址即从机内部的寄存器号码。这个号码很明显取决于从机是什么样子的，从机里面有多少个寄存器。有些十分简单的设备没有内部寄存器，但是大部分都有。CMPS03拥有16个，SRF08拥有36个。发送I2C地址和内部寄存器地址以后，就可以发送数据字节了。主机可以继续发送数据给从机，数据将被放置到后续到寄存器中，因为从机在每字节传输完成后将内部寄存器地址加1。当主机完成写入所有数据到从机时，主机将发送终止I2C通信到停止信号。为了写入数据到从机：
1.发送开始信号 
2.发送从机的I2C地址和读写位（LSB） 
3.发送你想写入内部寄存器的编号 
4.发送数据字节 
5.［可选，发送后续数据］ 
6.发送终止信号

举个例子，你有一个SRF08，他默认的I2C地址为0xE0。为了写入0x51到命令寄存器0x00，你需要这样： 
1.发送开始信号
2.发送0xE0（SRF08的I2C地址包括读写位）（偶数地址）
3.发送0x00（命令寄存器的内部地址）
4.发送0x51（你想写入的数据）
5.发送终止信号 


**从从机读取数据** 这有点复杂，但不是很难。在从从机读取数据前，你一定要告诉从机你想要读取寄存器的内部地址。所以读取从机事实上是从写入开始的。这与你写入数据一样：发送开始信号，从机的I2C地址和写位（0）和你想写的那边寄存器号码。然后再次发送另外一个开始信号（有时候叫做重开始）和I2C地址和读位（1）。你然后读取你想要的数据字节，最后以发送终止信号来终止会话。所以从CMPS03组件中读取一字节数据应该这样 
1.发送开始信号
2.发送0xC0（CMPS03的I2C地址和读写位低电平（偶数地址））
3.发送0x01（内部寄存器地址）
4.再次发送开始信号
5.发送0xC1（CMPS03的I2C地址和读写位高电平（奇数地址））
6.从CMPS03读取数据
7.发送终止信号
位序应该是这个样子
[![i2c](/images/old/2015/12/i2c.gif)](/images/old/2015/12/i2c.gif)